<!DOCTYPE html>
<html>
  <head>
    <title>List</title>
    <meta content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="../resources/styles/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="../resources/scripts/bootstrap.min.js"></script>
    <script src="../resources/scripts/jquery.js"></script>
    <script src="../resources/scripts/jquery.loadTemplate-1.3.2.min.js"></script>
     
    <style>
    body{
       margin-bottom: 40px;
    }
    </style>
    <script>    
    
    	var prmstr = window.location.search.substr(1);
        var prmarr = prmstr.split ("&");
        var params = {};
		var idCat = 0; 
        var currentPage=1;
        
        for ( var i = 0; i < prmarr.length; i++) {
            var tmparr = prmarr[i].split("=");
            params[tmparr[0]] = decodeURIComponent(tmparr[1]);
        }
                
        function page(item){
        	
        	if (item.id=='pageNext'){
        		getThreads(currentPage+1);
        		currentPage++;
            		
        	}
			if (item.id=='pagePre'){
				getThreads(currentPage-1);
        		currentPage--;
        	}
        	
        	if ($.isNumeric(item.innerHTML)){
        		currentPage=parseInt(item.innerHTML);
        		getThreads(item.innerHTML);
        	}
        	
    		$("#page"+prePage).parent().attr("class","");
    		$("#page"+currentPage).parent().attr("class","active");
    		
    	
    		if(currentPage==1)
    			$("#pagePre").parent().attr("class","active");
    		else
    		{
    			$("#pagePre").parent().attr("class","");
    			$("#pagePre").attr("href","/SelfCareCommunity/service/category/"+idCat+"/threads/page/"+(currentPage-1));
    			$("#pageNext").attr("href","/SelfCareCommunity/service/category/"+idCat+"/threads/page/"+(currentPage+1));
    		}
    	}
    		 	    	
    	function getThreads(pageNum){
    		    
    		var url="/SelfCareCommunity/service/category/"+idCat+"/threads/page/"+pageNum;

    		$.ajax({
    			url: url,
    			type: "get",
    			dataType: "json",
    			success: function(result){    
    				lastPage = result.last;
    				data=result.data;
    				if (lastPage==true){
    					$("#pageNext").hide();
    				} else {
    					$("#pageNext").show();
    						
    				} 
    				if (pageNum==1){
    					$("#pagePre").hide();
    				} else {
    					$("#pagePre").show();
    						
    				}
    				$("#threadList").html("");

    				for(var i=0;i<data.length;i++){
    			
    					var id=data[i].id;
    					var author=data[i].author.name;
    					var displayName=data[i].displayName;
    					var postCount=data[i].postCount;
    			

    					$("#threadList").append("<div id='thread"+id+"'></div>");
    					$("#thread"+id).loadTemplate("template/thread.html",
    					{
	    					author: author,
	    					url: "/SelfCareCommunity/content/view.html?id="+id+"&displayName="+displayName+"&postCount="+postCount,
	    					displayName:displayName,
	    					postCount:postCount
    					});		
    			}
    				
    	        	$("#container").show();
    			}
    			});
    		}
    	
    	$(function(){
    		
            $("#title").text(params['categName']);

	    	idCat= params['categoryId']; // used for getting the category id from URL
			
	    	var threadCount=params['threadCount'];	
    		var n=parseInt(threadCount/10)+1;
    		
			prePage=1;
			
			$("#pagePre").parent().attr("class","active");
			$("#page1").parent().attr("class","active");
			
			if(n>1)	{
				element = '<li><a onclick="page(this);return false;"id="pagePre">&laquo</a></li>';
				$("#page").append(element);
				for(var i=1;i<=n;i++){
					
					element = '<li><a onclick="page(this);return false;"id="page'+i+'">'+i+'</a></li>';
					$("#page").append(element);
				}
				element = '<li><a onclick="page(this);return false;"id="pageNext">&raquo;</a></li>';
				$("#page").append(element);
							
			}
			else{
				element = '<li><a onclick="page(this);return false;"id="page1">1</a></li>';
				$("#page").append(element);
				
			}
	    	
	    	getThreads(1);
    		
    		$("#categoryId").text(idCat);    		
    		
    		$("#btnThread").click(function(){
    			
    			var id=$("#categoryId").text();
    			var topic=$.trim($("#topic").val());
    			var content=$.trim($("#content").val());
    			    			
    			var url="/SelfCareCommunity/service/category/"+id+"/newthread";
    			//alert(url);
    			if(content.length==0 || topic.length==0)
    				return false;
    			else{
    				$.ajax({
    					  url: url,
    					  type: "POST",
    					  dataType: "json",
    					  contentType: 'application/json; charset=utf-8',
    					  data: JSON.stringify({ "topic":topic, "content":content}),
    					  success: function(){
    						  //alert("1");
    						  //$("#postSuccess").alert();
    						  $("#threadSuccess").show();

    					  },
    					  error: function(xhr, ajaxOptions, thrownError){
    						  //console.log(xhr.status+"  "+thrownError);
    						  //$("#postFail").alert();
    						  $("#threadFail").show();
    					  }
    					  
    				});
    				//$("#postSuccess").show();
    				return false;
    			}
    			
    			
    		});
    		
    	});
    	
   </script>

 </head>
 <body>

 <div id="new-header">
        <script>
            $("#new-header").load("header.html");
        </script>
</div>

<div id="container" style="display:none" class="span9 offset3">

	<h3 id="title"></h3>
	
	<div class="row" id="tableTitle">
	 	 	<div class="span5">
	 	 	<h4>Topic</h4>
	 	 	</div>
      		<div class="span2 muted" >
      		<h4>Author</h4>
      		</div>
      		<div class="span2 muted">
      		<h4>Reply number</h4>
      		</div>
	</div>
	<hr />

	<div id="threadList">
	</div>
	
	<div id="addThread">
	<div class="row">
	
	<div class="span5 offet2">
		<div id="threadSuccess"class="alert alert-success fade in hide" data-alert="alert">
	  		<button type="button" class="close" data-dismiss="alert" onclick="$(this).parent().hide()">&times;</button>
	  		<strong>Post success!</strong> 
		</div>
	
		<div id="threadFail" class="alert alert-error fade in hide" data-alert="alert">
	  		<button type="button" class="close" data-dismiss="alert" onclick="$(this).parent().hide()">&times;</button>
	  		<strong>Post fail!</strong> 
		</div>
	</div>
	
	<div class="pagination">
  	  <ul id="page" class="pull-right">
  	  	
  	  </ul>
	</div>
	
    <div class="span9">
     	 <form>
          	  <span id="categoryId" style="display:none"></span>
              <h4>Add a topic</h4>
                 <input type="text" class="span6" id="topic" placeholder="Type something about the topic">
                 <textarea class="field span9" rows="6" id="content"></textarea>
                 <div class="pull-right">
                 <button id="btnThread"class="btn btn-info" type="submit">Submit</button></div>
          </form>
   </div>
</div>
	</div>
</div>


</body>
</html>