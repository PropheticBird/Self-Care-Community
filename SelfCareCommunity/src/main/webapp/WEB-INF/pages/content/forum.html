<!DOCTYPE html>
<html>
  <head>
    <title>List</title>
    <meta content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="../resources/styles/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="../resources/scripts/bootstrap.min.js"></script>
    <script src="../resources/scripts/jquery.js"></script>
    <script src="../resources/scripts/jquery.loadTemplate-1.3.2.min.js"></script>
     
    <style>
    body{
       margin-bottom: 40px;
    }
    </style>
    <script>    	 	    	
    	function getThreads(id,pageNum){
    		    		
    		var url="/SelfCareCommunity/service/category/"+id+"/threads/page/"+pageNum;

    		$.ajax({
    			url: url,
    			type: "get",
    			dataType: "json",
    			success: function(result){    					
    				data=result.data;
    				for(var i=0;i<data.length;i++){
    			
    					var id=data[i].id;
    					var author=data[i].author.name;
    					var displayName=data[i].displayName;
    					var postCount=data[i].postCount;
    			
    					$("#threadList").append("<div id='thread"+id+"'></div>");
    					$("#thread"+id).loadTemplate("template/thread.html",
    					{
	    					author: author,
	    					url: "/SelfCareCommunity/content/view.html?id="+id+"&displayName="+displayName+"&postCount="+postCount,
	    					displayName:displayName,
	    					postCount:postCount
    					});		
    			}
    				
    	        	$("#container").show();
    			}
    			});
    		}
    	
    	$(function(){
    		
    		
    		var prmstr = window.location.search.substr(1);
            var prmarr = prmstr.split ("&");
            var params = {};

            for ( var i = 0; i < prmarr.length; i++) {
                var tmparr = prmarr[i].split("=");
                params[tmparr[0]] = tmparr[1];
            }
            
        	//alert(params['id']);
        	
        	getThreads(params['categoryId'],1);
    		
    		$("#categoryId").text(params['categoryId']);    		
    		
    		$("#btnThread").click(function(){
    			
    			var id=$("#categoryId").text();
    			var topic=$.trim($("#topic").val());
    			var content=$.trim($("#content").val());
    			    			
    			var url="/SelfCareCommunity/service/category/"+id+"/newthread";
    			//alert(url);
    			if(content.length==0 || topic.length==0)
    				return false;
    			else{
    				$.ajax({
    					  url: url,
    					  type: "POST",
    					  dataType: "json",
    					  contentType: 'application/json; charset=utf-8',
    					  data: JSON.stringify({ "topic":topic, "content":content}),
    					  success: function(){
    						  //alert("1");
    						  //$("#postSuccess").alert();
    						  $("#postSuccess").show();

    					  },
    					  error: function(xhr, ajaxOptions, thrownError){
    						  //console.log(xhr.status+"  "+thrownError);
    						  //$("#postFail").alert();
    						  $("#postFail").show();
    					  }
    					  
    				});
    				//$("#postSuccess").show();
    				return false;
    			}
    			
    			
    		});
    	});
    	
   </script>

 </head>
 <body>

   <div class="navbar">
  	<div class="navbar-inner">
    <a class="brand" href="#">SelfCareCommunity</a>
    <ul class="nav">
      <li class="active"><a href="#">Home</a></li>
      <li><a href="#">Link</a></li>
      <li><a href="#">Link</a></li>
    </ul>
  </div>
</div>

<div id="container" style="display:none;" class="span9 offset3">
	<h3 id="title">Category1</h3>
	<div id="threadList">
	</div>
	
	<div id="addThread">
	<div class="row">
	
	<div class="span5 offet2">
	<div id="postSuccess"class="alert alert-success fade in hide" data-alert="alert">
  		<button type="button" class="close" data-dismiss="alert">&times;</button>
  		<strong>Post success!</strong> 
	</div>
	
	<div id="postFail" class="alert alert-error fade in hide" data-alert="alert">
  		<button type="button" class="close" data-dismiss="alert">&times;</button>
  		<strong>Post fail!</strong> 
	</div>
	</div>
	
    <div class="span9">
     	 <form>
          	  <span id="categoryId" style="display:none"></span>
              <h4>Add a topic</h4>
                 <input type="text" class="span6" id="topic" placeholder="Type something about the topic">
                 <textarea class="field span9" rows="6" id="content"></textarea>
                 <div class="pull-right">
                 <button id="btnThread"class="btn btn-info" type="submit">Submit</button></div>
          </form>
   </div>
</div>
	</div>
</div>


</body>
</html>