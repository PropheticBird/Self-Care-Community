<!DOCTYPE html>
<html>
  <head>
    <title>View</title>
    <meta content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    
    <link href="../resources/styles/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="../resources/scripts/bootstrap.min.js"></script>
    <script src="../resources/scripts/jquery.js"></script>
    <script src="../resources/scripts/jquery.loadTemplate-1.3.2.min.js"></script>
    
    
    <style>
    body{
       margin-bottom: 40px;
    }
    </style>
    
    <script>
    var currentPage=0;
    var prePage=0;
    var restPages=0;
    var threadId;
    
    
    function like(item,identify){
   	 //alert($(item).attr("alt"));
   	 //alert(item.children("span")[0].val());
   	 //return false;
   	 var id=parseInt($(item).attr("alt"));
   	 
     //alert($(".likes")[id-1].innerHTML);     
   	 var url="/SelfCareCommunity/service/post/"+id+"/like";
   	 if(identify=="1"){
   		 $.ajax({
   			 url:url,
   			 type:"PUT",
   			 success:function(result){
   				 var likes=$(".likes")[(id-1)%5].innerHTML;
   				 var num=parseInt(likes.replace(/[^\d]/g,''))+1;
   				 $(".likes")[(id-1)%5].innerHTML=num+" likes";
   			 }
   		 });
   	 }
   	 else{
   		 $.ajax({
   			 url:url,
   			 type:"DELETE",
   			 success:function(result){
   				var likes=$(".likes")[(id-1)%5].innerHTML;
  				var num=parseInt(likes.replace(/[^\d]/g,''));
  				if(num>0)
  					num=num-1;
  				$(".likes")[(id-1)%5].innerHTML=num+" likes";
   			 }
   		 });
   	 }
   	 
    }
    
    
    
    function getPosts(url){
		$.ajax({
			url: url,
			type: "get",
			dataType: "json",
			success: function(result){
			
			$("#postList").html("");
				data=result.data;
				for(var i=0;i<data.length;i++){
					var id=data[i].id;
					var author=data[i].author.name;
					var content=data[i].content;
					var date=data[i].postedDate;
					var likes=data[i].likes;
								
					$("#postList").append("<div id='post"+id+"'></div>");
					$("#post"+id).loadTemplate("template/post.html",
					{
						authorPic: '../resources/img/avatar.png',
						author: author,
						content: content,
						date: date,
						likes: likes+" likes",
						postId: data[i].id
					});
			}
			}
			});
		}	
	
	function page(item){
		//alert(item.parent().attr("class"));
		//alert(item.innerHTML);
		getPosts(item.href);
		prePage=currentPage;
		currentPage=parseInt(item.innerHTML);
		$("#page"+prePage).parent().attr("class","");
		$("#page"+currentPage).parent().attr("class","active");
		if(currentPage==1)
			$("#pagePre").parent().attr("class","active");
		else
		{
			$("#pagePre").parent().attr("class","");
			$("#pagePre").attr("href","/SelfCareCommunity/service/thread/"+threadId+"/posts/page/"+(currentPage-1));
			$("#pageNext").attr("href","/SelfCareCommunity/service/thread/"+threadId+"/posts/page/"+(currentPage+1));
		}
		
		
	}
	
	$(function(){
		
		
		 var prmstr = window.location.search.substr(1);
		    var prmarr = prmstr.split ("&");
		    var params = {};

		    for ( var i = 0; i < prmarr.length; i++) {
		        var tmparr = prmarr[i].split("=");
		        params[tmparr[0]] = decodeURIComponent(tmparr[1]);
		    }
		   
			
			//alert(params['id']);
			getPosts("/SelfCareCommunity/service/thread/"+params['id']+"/posts/page/1");
			//alert(params['displayName']);
			//alert(params['postCount']);
			var postCount=parseInt(params['postCount']);
			var n=parseInt(postCount/5)+1;
			restPages=n-5;
			currentPage=1;
			prePage=1;
			threadId=params['id'];
			//alert(n);
			//alert($("#page1").attr("href"))
			$("#pagePre").parent().attr("class","active");
			$("#page1").parent().attr("class","active");
			if(restPages<0)
			{
				for(var i=1;i<=n;i++){
					$("#page"+i).attr("href", "/SelfCareCommunity/service/thread/"+params['id']+"/posts/page/"+i);
					//alert($("#page"+i).attr("href"));
				}
				for(var i=n+1;i<=5;i++){
					$("#page"+i).hide();
				}
				$("#pageNext").attr("href","/SelfCareCommunity/service/thread/"+params['id']+"/posts/page/2");
			}
			else{
				for(var i=1;i<=5;i++){
					$("#page"+i).attr("href", "/SelfCareCommunity/service/thread/"+params['id']+"/posts/page/"+i);
				}
				$("#pageNext").attr("href","/SelfCareCommunity/service/thread/"+params['id']+"/posts/page/2");
			}

		
			
		$("#threadId").text(params['id']);
		$("#title").text(params['displayName']);
		
		/*
		$("a.page").click(function(){
			alert($("#page1").attr("href"));
			getPosts($("a.page").attr("href"));
			return false;
		});*/
		

		
		$("#btnPost").click(function(){
			var id=$("#threadId").html();
			var content=$.trim($("#content").val());
			var url="/SelfCareCommunity/service/thread/"+id+"/newpost";
			//alert(url);
			if(content.length==0)
				return false;
			else{
				$.ajax({
					  url: url,
					  type: "POST",
					  dataType: "json",
					  contentType: 'application/json; charset=utf-8',
					  data: JSON.stringify({ "content":content}),
					  success: function(){
						  //alert("1");
						  //$("#postSuccess").alert();
						  $("#postSuccess").show();

					  },
					  error: function(xhr, ajaxOptions, thrownError){
						  //console.log(xhr.status+"  "+thrownError);
						  //$("#postFail").alert();
						  $("#postFail").show();
					  }
					  
				});
				//$("#postSuccess").show();
				return false;
			}
		});	
	});
	
  	 </script>

 </head>
 
 <body>
   <div class="navbar">
  	<div class="navbar-inner">
    <a class="brand" href="#">SelfCareCommunity</a>
    <ul class="nav">
      <li class="active"><a href="#">Home</a></li>
      <li><a href="#">Link</a></li>
      <li><a href="#">Link</a></li>
    </ul>
  </div>
</div>




<div id="container" class="span9 offset3">
	<h3 id="title"></h3>
	
	<div id="postList">
	</div>
	
	<div class="pagination">
  	  <ul id="page" class="pull-right">
  	  	<li class=""><a href="" onclick="page(this);return false;" id="pagePre">&laquo;</a></li>
    	<li class=""><a href="" onclick="page(this);return false;" id="page1">1</a></li>
    	<li class=""><a href=""  onclick="page(this);return false;" id="page2">2</a></li>
    	<li class=""><a href=""  onclick="page(this);return false;" id="page3">3</a></li>
     	<li class=""><a href=""  onclick="page(this);return false;" id="page4">4</a></li>
     	<li class=""><a href="" onclick="page(this);return false;"  id="page5">5</a></li>
    	<li class=""><a href="" onclick="page(this);return false;"  id="pageNext">&raquo;</a></li>
  	  </ul>
	</div>
	
	<div id="addPost">
	<div class="row">

	<div class="span5 offet2">
	<div id="postSuccess"class="alert alert-success fade in hide" data-alert="alert">
  		<button type="button" class="close" data-dismiss="alert">&times;</button>
  		<strong>Post success!</strong> 
	</div>
	
	<div id="postFail" class="alert alert-error fade in hide" data-alert="alert">
  		<button type="button" class="close" data-dismiss="alert">&times;</button>
  		<strong>Post fail!</strong> 
	</div>
	</div>
	
    <div class="span9">
    	<form>
    		<span id="threadId" style="display:none"></span>
        	<h4>Reply to this topic</h4>
            <textarea class="field span9" rows="6" id="content" required></textarea>
            <div class="pull-right">
            <button id="btnPost" class="btn btn-info" type="submit">Submit</button>
            </div>
        </form>
   </div>
</div>
	</div>
	

</div>



 </body>
</html>