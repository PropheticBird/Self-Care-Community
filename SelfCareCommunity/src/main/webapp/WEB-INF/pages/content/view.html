<!DOCTYPE html>
<html>
  <head>
    <title>View</title>
    <meta content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    
    <link href="../resources/styles/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="../resources/scripts/bootstrap.min.js"></script>
    <script src="../resources/scripts/jquery.js"></script>
    <script src="../resources/scripts/jquery.loadTemplate-1.3.2.min.js"></script>
    
    
    <style>
    body{
       margin-bottom: 40px;
    }
    .page_num{
    cursor: pointer;
    }
    </style>
    
    <script>
        
    var currentPage=1;
    var prePage=0;
	var num_pages=0; // it will store the number of pages we will have
    var lastPage=false; // this variable is FALSE if it is not the last page and it is TRUE if it is THE LAST PAGE
    var threadId=0;
    
    
    function like(item,identify){
        
      	 var id=parseInt($(item).attr("alt"));
      	
      	 var url="/SelfCareCommunity/service/post/"+id+"/like";
      	 
      	 if(identify=="1"){
      		 $.ajax({
      			 url:url,
      			 type:"PUT",
      			 success:function(result){
      
      				var like=$(item).parent().parent().find("p")[1];
      				var likeContent=like.innerHTML;
      				var num=parseInt(likeContent.replace(/[^\d]/g,''));
      				if(likeContent.indexOf("-")>=0){
      					num=0-num;
          				//alert(num);
      				}
      				num=num+1;
      				//alert(likeContent.replace(/[^(\d | '-')]/g,''));
      				$(item).parent().parent().find("p")[1].innerHTML=num+" recommends";	 
      						 
      			 }
      		 });
      	 }
      	 else{
      		 $.ajax({
      			 url:url,
      			 type:"DELETE",
      			 success:function(result){
      				var like=$(item).parent().parent().find("p")[1];
      				var likeContent=like.innerHTML;
      				var num=parseInt(likeContent.replace(/[^\d]/g,''));
      				if(likeContent.indexOf("-")>=0){
      					num=0-num;
          				//alert(num);
      				}
      				num=num-1;
      				$(item).parent().parent().find("p")[1].innerHTML=num+" recommends";	   			 
     			}
      		 });
      	 }
      	 
      	$(item).attr("disabled","true");
      	 
       }
    
    
    
    function paginationManagement(last, current){ // this function will handle the visualization of the elements
    	if (last==true){
			$(".pageNext").hide();
		} else {
			$(".pageNext").show();
		} 
		if (current==1){
			$(".pagePre").hide();
		} else {
			$(".pagePre").show();
		}
		
		//in case the number of pages is bigger than 6...
		if (num_pages> 4 ) {
			$(".tempAfter").remove();	
			$(".tempBefore").remove();	
			for (i= 3; i<=(num_pages -2); i++){
					$(".page" + i).hide();	
				
			}
			if (current < (num_pages - 2) -1) {
				$(".page"+(current+1)).after("<span class='tempAfter'>. . .</span>");
			}	
			if (current > 4) {
				$(".page"+(current-1)).before("<span class='tempBefore'>. . .</span>");
			}
			for (i= 1; i<=num_pages; i++){
				if (( i == current)||  (i == current +1) || (i == current -1)) {
				
					$(".page" + i).show();	
				}
			}
	

		}
		
		
    }
    
    
    function getPosts(pagNum){
    	var url = "/SelfCareCommunity/service/thread/"+threadId+"/posts/page/"+pagNum;
		$.ajax({
			url: url,
			type: "get",
			dataType: "json",
			success: function(result){
			lastPage = result.last;
			
			paginationManagement(lastPage,  currentPage);
			
			$("#postList").html("");
				data=result.data;
				for(var i=0;i<data.length;i++){
					var id=data[i].id;
					var author=data[i].author.name;
					var content=data[i].content;
					var date=data[i].postedDate;
					var likes=data[i].likes;
								
					$("#postList").append("<div id='post"+id+"'></div>");
					$("#post"+id).loadTemplate("template/post.html",
					{
						authorPic: '../resources/img/avatar.png',
						author: author,
						content: content,
						date: date,
						likes: likes+" recommends",
						postId: data[i].id
					});
			}
				$("#container").show();
			}
			});
		}	
	
    function changeNums(tPrePage, tcPage) {
    	
		prePage = tPrePage;	
		currentPage=tcPage;


		clas='.page'+prePage+'span';
		
		$(".page"+prePage).parent().attr("class","");
		//console.log($(clas).parent().attr());
		
		$(clas).attr('class','page'+prePage+'span');
		
		clas='.page'+currentPage+'span';
		
		$(".page"+currentPage).parent().attr("class","active");
		$(clas).attr("class","page"+currentPage+"span label label-info");
		
		if(currentPage==1)
			$(".pagePre").parent().attr("class","active");
		else
		{
			$(".pagePre").parent().attr("class","");
			$(".pagePre").attr("href","/SelfCareCommunity/service/thread/"+threadId+"/posts/page/"+(currentPage+1));
			$(".pageNext").attr("href","/SelfCareCommunity/service/thread/"+threadId+"/posts/page/"+(currentPage-1));
		}
    }
    
	function page(item){
		prePage=currentPage;
		
		if (item.className=='pageNext'){
			currentPage++;
			getPosts(currentPage);
    			
    	}
		if (item.className=='pagePre'){
			currentPage--;
			getPosts(currentPage);
    		
    	}
    	
    	if ($.isNumeric(item.innerText)){
    		currentPage=parseInt(item.innerText);
    		getPosts(item.innerText);
    	} 
    	changeNums(prePage, currentPage);
		
	}
		
	$(function(){
		 	var prmstr = window.location.search.substr(1);
		    var prmarr = prmstr.split ("&");
		    var params = {};

		    for ( var i = 0; i < prmarr.length; i++) {
		        var tmparr = prmarr[i].split("=");
		        params[tmparr[0]] = decodeURIComponent(tmparr[1]);
		    }
		   
			threadId=params['id'];
			var postCount=parseInt(params['postCount']);
			num_pages=parseInt(postCount/5)+1; // it calculates the numbe of pages we will have
			
			currentPage=1;
			prePage=1;
			
			getPosts(1);
		
			if(num_pages>1)
			{
				element = '<li><a onclick="page(this);return false;"class="pagePre">&laquo</a></li>';
				$(".page").append(element);
				
				element = '<li><a onclick="page(this);return false;"class="page1"><span class="page1span label label-info">1</span></a></li>';
				$(".page").append(element);
				
				for(var i=2;i<=num_pages;i++){				
					clas='page'+i+'span';
					element = '<li><a onclick="page(this);return false;"class="page'+i+'" ><span class='+clas+' >'+i+'</span></a></li>';
					$(".page").append(element);
				}
				element = '<li><a onclick="page(this);return false;"class="pageNext">&raquo;</a></li>';
				$(".page").append(element);
			}
			else{
				element = '<li><a onclick="page(this);return false;"class="page1">1</a></li>';
				$(".page").append(element);	
			}
			
			$(".pagePre").parent().attr("class","active");
			$(".page1").parent().attr("class","active");
			
		$("#threadId").text(threadId);
		$("#title").text(params['displayName']);
				
		$("#btnPost").click(function(){
			var id=$("#threadId").html();
			var content=$.trim($("#content").val());
			var url="/SelfCareCommunity/service/thread/"+id+"/newpost";
			
			if(content.length==0)
				return false;
			else{
				$.ajax({
					  url: url,
					  type: "POST",
					  dataType: "json",
					  contentType: 'application/json; charset=utf-8',
					  data: JSON.stringify({ "content":content}),
					  success: function(){
						  $("#postSuccess").show();
						 var lastpage=parseInt(params['postCount']/5)+1;
						 getPosts(lastpage, num_pages);

						 changeNums(currentPage, lastpage);

						 $('#content').val("");
					  },
					  error: function(xhr, ajaxOptions, thrownError){
						  $("#postFail").show();
					  }
					  
				});
				return false;
			}
		});	
	});
	
	
// zoom functionality	
	var CurrentWidth = 0;	
	var CurrentHeight = 0;	
	var zoom=0;

	function ZoomOut(){
		 if (zoom > 10) {
			 zoom = zoom - 10; 
		 	$('.posts').css('zoom', '1'+zoom+'%')
		 } 
			 
		if (zoom == 10) {
			zoom = 0;
		 	$('.posts').css('zoom', '100%')
		 	 document.getElementById("zoomOut").setAttribute("style","display:none");  
		}

	 }
	 
	 function ZoomIn (){
		 document.getElementById("zoomOut").setAttribute("style","display:block"); 
		 if (zoom <= 80) {
			 zoom = zoom + 10; 
			 $('.posts').css('zoom', '1'+zoom+'%');
			 //
			 width = $("#postList").width();
				width = width + 50;
			 $("#postList").width(width + "px");
		 } else
			 window.alert("You cannot Zoom In more");
			
	 }
  	 </script>

 </head>
 
 <body>
 
 <div id="new-header">
        <script>
            $("#new-header").load("header.html");
        </script>
</div>

	<div id="container" style="display:none;" class="span11 offset3">
			  <h3 id="title"style="position:relative;float:left;"></h3>
			  
			  
			  <div class="zoom-buttons" style="float:right;position:relative;">
		        	<img id="zoomIn" src="../resources/styles/icons/1386539999_34629.ico" style="display:block; float:right" onclick="ZoomIn();" width="50px" height="50px"/>
		      		<img id="zoomOut" src="../resources/styles/icons/1386540011_34630.ico" style="display:none; float:right" onclick="ZoomOut();" width="50px" height="50px" />
		        </div>
		   
			<br><br><br>
			<div class="pagination pagination-large">
				
				<div class="pagination pagination-centered">
			  	  <ul class="page" > </ul>
				</div>
			</div>
			
			
			<div id="postList" class="posts">
			</div>
			
			<div class="pagination pagination-large">
				
				<div class="pagination pagination-centered">
			  	  <ul class="page" > </ul>
				</div>
			</div>
			
		
			<div id="addPost">
		
		
			<div id="postSuccess"class="alert alert-success fade in hide" data-alert="alert">
		  		<button type="button" class="close" data-dismiss="alert">&times;</button>
		  		<strong>Post success!</strong> 
			</div>
			
			<div id="postFail" class="alert alert-error fade in hide" data-alert="alert">
		  		<button type="button" class="close" data-dismiss="alert">&times;</button>
		  		<strong>Post fail!</strong> 
			</div>
		
			
		    <div class="span10">
		    	<form>
		    		<span id="threadId" style="display:none"></span>
		        	<h4>Reply to this topic</h4>
		            <textarea class="field span10" rows="6" id="content" required></textarea>
		            <div class="pull-right">
		            <button id="btnPost" class="btn btn-info" type="submit">Submit</button>
		            </div>
		        </form>
		   </div>
		</div>
    </div>


 </body>
</html>